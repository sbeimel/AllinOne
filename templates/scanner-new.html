{% extends "base.html" %}

{% block title %}MAC Scanner NEW (Async) - MacReplayXC{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="container-xl">
        <div class="row g-2 align-items-center">
            <div class="col">
                <h2 class="page-title">
                    <i class="ti ti-radar me-2"></i>MAC Scanner NEW (Async)
                    <span class="badge bg-success ms-2">10-100x Faster!</span>
                </h2>
                <div class="text-muted mt-1">
                    <small>Async I/O with up to 1000 concurrent tasks - Perfect for 100+ proxies</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="page-body">
    <div class="container-xl">
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="scan-tab" data-bs-toggle="tab" data-bs-target="#scan-panel" type="button" role="tab">
                    <i class="ti ti-radar me-1"></i>Scan
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-panel" type="button" role="tab">
                    <i class="ti ti-settings me-1"></i>Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="proxies-tab" data-bs-toggle="tab" data-bs-target="#proxies-panel" type="button" role="tab">
                    <i class="ti ti-network me-1"></i>Proxies
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="found-tab" data-bs-toggle="tab" data-bs-target="#found-panel" type="button" role="tab">
                    <i class="ti ti-database me-1"></i>Found MACs
                </button>
            </li>
        </ul>
        
        <div class="tab-content">
            
            <!-- SCAN TAB -->
            <div class="tab-pane fade show active" id="scan-panel" role="tabpanel">
                
                <!-- Start New Scan -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">Start New Scan</h3>
                    </div>
                    <div class="card-body">
                        <form id="scannerForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label required">Portal URL</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="portalUrl" 
                                               placeholder="http://portal.com/c" required>
                                        <button type="button" class="btn btn-secondary" 
                                                onclick="autoDetectPortal()" 
                                                title="Auto-detect portal endpoint">
                                            <i class="ti ti-search"></i> Auto-Detect
                                        </button>
                                    </div>
                                    <small class="form-hint">Portal URL to scan (Auto-Detect finds correct endpoint)</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Mode</label>
                                    <select class="form-select" id="scanMode">
                                        <option value="random">Random MACs</option>
                                        <option value="list">MAC List</option>
                                        <option value="xscan">Xscan (MAC Range)</option>
                                        <option value="refresh">Refresh Found MACs</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Speed (Concurrent Tasks)</label>
                                    <input type="number" class="form-control" id="scanSpeed" 
                                           value="100" min="10" max="1000">
                                    <small class="form-hint text-success">Async: Up to 1000 tasks!</small>
                                </div>
                            </div>
                            
                            <div class="row mb-3" id="macListRow" style="display: none;">
                                <div class="col-md-12">
                                    <label class="form-label">MAC List (one per line)</label>
                                    <textarea class="form-control" id="macList" rows="5" 
                                              placeholder="00:1A:79:XX:XX:XX&#10;00:1A:79:YY:YY:YY"></textarea>
                                    <small class="form-hint">Or upload a file below</small>
                                </div>
                            </div>
                            
                            <div class="row mb-3" id="macFileRow" style="display: none;">
                                <div class="col-md-12">
                                    <label class="form-label">Upload MAC List File</label>
                                    <input type="file" class="form-control" id="macFileInput" accept=".txt,.csv">
                                    <small class="form-hint">Supported formats: .txt, .csv (one MAC per line)</small>
                                </div>
                            </div>
                            
                            <div class="row mb-3" id="xscanRangeRow" style="display: none;">
                                <div class="col-md-6">
                                    <label class="form-label">Start MAC</label>
                                    <input type="text" class="form-control" id="macRangeStart" 
                                           placeholder="00:1A:79:00:00:00">
                                    <small class="form-hint">Starting MAC address of range</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">End MAC</label>
                                    <input type="text" class="form-control" id="macRangeEnd" 
                                           placeholder="00:1A:79:00:FF:FF">
                                    <small class="form-hint">Ending MAC address of range (max 1M MACs)</small>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">MAC Prefix (for random mode)</label>
                                    <input type="text" class="form-control" id="macPrefix" 
                                           value="00:1A:79:" placeholder="00:1A:79:">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="scanTimeout" 
                                           value="10" min="5" max="30">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="form-label">Proxies (optional, one per line)</label>
                                    <textarea class="form-control" id="proxies" rows="3" 
                                              placeholder="http://proxy1:port&#10;socks5://proxy2:port"></textarea>
                                    <small class="form-hint">Leave empty to use saved proxies or scan without proxies</small>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="ti ti-radar me-2"></i>Start Scan
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Active Scans -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">Active Scans</h3>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-ghost-secondary" onclick="refreshStatus()">
                                <i class="ti ti-refresh"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="activeScans">
                            <div class="text-muted text-center py-4">
                                <i class="ti ti-radar" style="font-size: 3rem; opacity: 0.3;"></i>
                                <p class="mt-2">No active scans</p>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            <!-- END SCAN TAB -->
            
            <!-- SETTINGS TAB -->
            <div class="tab-pane fade" id="settings-panel" role="tabpanel">
                
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">ðŸ’¡ Recommended Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <strong>FÃ¼r maximale Genauigkeit (langsamer):</strong><br>
                            Geschwindigkeit: 50-100 Tasks | Max Proxy-Fehler: 8-10 | Proxy-Rotation: 70% | Verbindungs-Timeout: 8s | Unbegrenzte Wiederholungen: AN<br>
                            <em>KompatibilitÃ¤tsmodus: AUS (intelligente Wiederholungslogik)</em><br><br>
                            
                            <strong>FÃ¼r ausgewogene Leistung:</strong><br>
                            Geschwindigkeit: 100-200 Tasks | Max Proxy-Fehler: 5-8 | Proxy-Rotation: 50% | Verbindungs-Timeout: 5s | Max Proxy-Versuche: 15<br>
                            <em>KompatibilitÃ¤tsmodus: AUS (empfohlen)</em><br><br>
                            
                            <strong>FÃ¼r schnelles Scannen (hÃ¶here Falsch-Negative):</strong><br>
                            Geschwindigkeit: 200-500 Tasks | Max Proxy-Fehler: 3-5 | Proxy-Rotation: 30% | Verbindungs-Timeout: 3s | Max Proxy-Versuche: 5<br>
                            <em>KompatibilitÃ¤tsmodus: AN (MacAttack.pyw Verhalten - schneller aber weniger genau)</em><br><br>
                            
                            <strong>FÃ¼r Stealth-Modus (Erkennung vermeiden):</strong><br>
                            Geschwindigkeit: 20-30 Tasks | Anfrage-VerzÃ¶gerung: 1,5s | User-Agent-Rotation: AN | Proxy-Rotation: Alle 5 Anfragen<br>
                            <em>KompatibilitÃ¤tsmodus: AUS (intelligenter Modus fÃ¼r bessere Genauigkeit)</em><br><br>
                            
                            <strong>Ohne Proxies (Direkte Verbindung):</strong><br>
                            Geschwindigkeit: 20-50 Tasks | Lese-Timeout: 15-20s (Portale kÃ¶nnen langsam sein)<br>
                            <em>KompatibilitÃ¤tsmodus: AUS (keine Proxies zum Wiederholen vorhanden)</em><br><br>
                            
                            <hr class="my-3">
                            <strong>ðŸ“– KompatibilitÃ¤tsmodus erklÃ¤rt:</strong><br>
                            <strong>AUS (Standard):</strong> Intelligenter Modus - analysiert Antwort um zu entscheiden ob MAC ungÃ¼ltig ist oder ob es ein Proxy/Netzwerk-Problem ist. Wiederholt mit anderem Proxy bei Fehlern. <strong>Bessere Genauigkeit, findet mehr gÃ¼ltige MACs.</strong><br>
                            <strong>AN:</strong> MacAttack.pyw Verhalten - kein Token = MAC sofort ungÃ¼ltig, keine Wiederholung. <strong>Schneller aber hÃ¶here Falsch-Negative.</strong>
                        </div>
                        <div class="btn-list">
                            <button class="btn btn-success" onclick="applyMaxAccuracy()">
                                <i class="ti ti-target me-2"></i>Apply Max Accuracy
                            </button>
                            <button class="btn btn-primary" onclick="applyBalanced()">
                                <i class="ti ti-adjustments me-2"></i>Apply Balanced
                            </button>
                            <button class="btn btn-warning" onclick="applyFastScan()">
                                <i class="ti ti-bolt me-2"></i>Apply Fast Scan
                            </button>
                            <button class="btn btn-info" onclick="applyStealth()">
                                <i class="ti ti-eye-off me-2"></i>Apply Stealth
                            </button>
                            <button class="btn btn-secondary" onclick="applyNoProxy()">
                                <i class="ti ti-plug-off me-2"></i>Apply No Proxy
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">Scanner Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Speed (Concurrent Tasks)</label>
                                <input type="number" class="form-control" id="settingSpeed" min="10" max="1000" value="100">
                                <small class="form-hint">Async supports up to 1000 concurrent tasks!</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Timeout (seconds)</label>
                                <input type="number" class="form-control" id="settingTimeout" min="1" max="60" value="10">
                                <small class="form-hint">Request timeout</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">MAC Prefix</label>
                                <input type="text" class="form-control" id="settingMacPrefix" value="00:1A:79:">
                                <small class="form-hint">Default MAC prefix for random mode</small>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Min Channels for Valid Hit</label>
                                <input type="number" class="form-control" id="settingMinChannels" min="0" max="1000" value="1">
                                <small class="form-hint">Minimum channels required</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Max Proxy Errors</label>
                                <input type="number" class="form-control" id="settingMaxProxyErrors" min="1" max="20" value="10">
                                <small class="form-hint">Disable proxy after N errors</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Proxy Rotation %</label>
                                <input type="number" class="form-control" id="settingProxyRotation" min="10" max="100" value="80">
                                <small class="form-hint">% of best proxies to use</small>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <h4 class="mb-3">ðŸ¥· Stealth Settings</h4>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Request Delay (seconds)</label>
                                <input type="number" class="form-control" id="settingRequestDelay" min="0" max="10" step="0.1" value="0">
                                <small class="form-hint">Pause between requests (0 = disabled)</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Force Proxy Rotation Every</label>
                                <input type="number" class="form-control" id="settingForceProxyRotation" min="0" max="100" value="0">
                                <small class="form-hint">Requests (0 = disabled)</small>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="settingUserAgentRotation">
                                    <label class="form-check-label" for="settingUserAgentRotation">User-Agent Rotation</label>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="settingUseProxies">
                                    <label class="form-check-label" for="settingUseProxies">Use Proxies</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="settingAutoSave" checked>
                                    <label class="form-check-label" for="settingAutoSave">Auto-save Found MACs</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="settingRequireChannels" checked>
                                    <label class="form-check-label" for="settingRequireChannels">Require Channels for Valid Hit</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="settingUnlimitedRetries">
                                    <label class="form-check-label" for="settingUnlimitedRetries">Unlimited Proxy Retries</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3" id="maxProxyAttemptsRow">
                            <div class="col-md-6">
                                <label class="form-label">Max Proxy Attempts per MAC</label>
                                <input type="number" class="form-control" id="settingMaxProxyAttempts" min="1" max="100" value="20">
                                <small class="form-hint">Wird ignoriert wenn "Unlimited Proxy Retries" aktiviert ist</small>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="settingCompatibleMode">
                                    <label class="form-check-label" for="settingCompatibleMode">MacAttack.pyw Compatible Mode</label>
                                    <small class="form-hint d-block ms-4">
                                        <strong>ON:</strong> Like MacAttack.pyw - no token = MAC invalid (no proxy retry)<br>
                                        <strong>OFF:</strong> Intelligent mode - analyze response to decide retry vs invalid
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <h4 class="mb-3">ðŸŽ¯ Advanced Features (Async)</h4>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="settingCloudflareBypass" checked>
                                    <label class="form-check-label" for="settingCloudflareBypass">Cloudflare Bypass (CFR)</label>
                                    <small class="form-hint d-block ms-4">Cloudflare-spezifische Header fÃ¼r bessere Erfolgsrate</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="settingRandomXForwardedFor" checked>
                                    <label class="form-check-label" for="settingRandomXForwardedFor">Random X-Forwarded-For</label>
                                    <small class="form-hint d-block ms-4">ZufÃ¤llige IP-Adressen fÃ¼r Rate-Limit Bypass</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="settingDeduplicateMACs" checked>
                                    <label class="form-check-label" for="settingDeduplicateMACs">MAC Listen Deduplizierung</label>
                                    <small class="form-hint d-block ms-4">Duplikate automatisch entfernen</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="settingGenerateNeighborMACs">
                                    <label class="form-check-label" for="settingGenerateNeighborMACs">Nachbar-MACs Generieren</label>
                                    <small class="form-hint d-block ms-4">Pattern-basierte MAC-Generierung (z.B. ...67 â†’ ...66, ...68)</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3" id="neighborRangeRow" style="display: none;">
                            <div class="col-md-12">
                                <label class="form-label">Nachbar-MAC Bereich (Â±)</label>
                                <input type="number" class="form-control" id="settingNeighborRange" min="1" max="20" value="5">
                                <small class="form-hint">Anzahl der Nachbar-MACs in jede Richtung (z.B. 5 = Â±5 MACs)</small>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="saveSettings()">
                            <i class="ti ti-device-floppy me-2"></i>Save Settings
                        </button>
                        <button class="btn btn-secondary" onclick="loadSettings()">
                            <i class="ti ti-refresh me-2"></i>Reload Settings
                        </button>
                    </div>
                </div>
                
            </div>
            <!-- END SETTINGS TAB -->
            
            <!-- PROXIES TAB -->
            <div class="tab-pane fade" id="proxies-panel" role="tabpanel">
                
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">Proxy Management</h3>
                    </div>
                    <div class="card-body">
                        <div class="btn-list mb-3">
                            <button class="btn btn-primary" onclick="fetchProxies()">
                                <i class="ti ti-download me-2"></i>Fetch Proxies
                            </button>
                            <button class="btn btn-warning" onclick="testProxies()">
                                <i class="ti ti-test-pipe me-2"></i>Test Proxies
                            </button>
                            <button class="btn btn-info" onclick="testAutodetect()">
                                <i class="ti ti-search me-2"></i>Test & Auto-Detect
                            </button>
                            <button class="btn btn-danger" onclick="removeFailedProxies()">
                                <i class="ti ti-trash me-2"></i>Remove Failed
                            </button>
                            <button class="btn btn-secondary" onclick="resetProxyErrors()">
                                <i class="ti ti-refresh me-2"></i>Reset Errors
                            </button>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Proxy List (<span id="proxyCount">0</span> proxies)</label>
                                <textarea class="form-control" id="proxyList" rows="10" 
                                          placeholder="http://proxy1:port&#10;socks5://proxy2:port"></textarea>
                                <button class="btn btn-success mt-2" onclick="saveProxies()">
                                    <i class="ti ti-device-floppy me-2"></i>Save Proxies
                                </button>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Proxy Sources</label>
                                <textarea class="form-control" id="proxySources" rows="10" 
                                          placeholder="https://example.com/proxy-list.txt"></textarea>
                                <button class="btn btn-success mt-2" onclick="saveProxySources()">
                                    <i class="ti ti-device-floppy me-2"></i>Save Sources
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Proxy Log</h3>
                    </div>
                    <div class="card-body">
                        <div id="proxyLog" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;">
                            <div class="text-muted">No proxy operations yet</div>
                        </div>
                    </div>
                </div>
                
            </div>
            <!-- END PROXIES TAB -->
            
            <!-- FOUND MACS TAB -->
            <div class="tab-pane fade" id="found-panel" role="tabpanel">
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Found MACs (Hits)</h3>
                        <div class="card-actions">
                            <div class="btn-list">
                                <button class="btn btn-sm btn-ghost-info" onclick="crawlPortals()" title="Find new portals from urlscan.io">
                                    <i class="ti ti-world-search"></i> Find Portals
                                </button>
                                <button class="btn btn-sm btn-ghost-success" onclick="exportAllToM3U()" title="Export all found MACs as single M3U">
                                    <i class="ti ti-file-download"></i> Export All M3U
                                </button>
                                <button class="btn btn-sm btn-ghost-secondary" onclick="refreshHits()">
                                    <i class="ti ti-refresh"></i> Refresh
                                </button>
                                <button class="btn btn-sm btn-ghost-primary" onclick="exportHits()">
                                    <i class="ti ti-download"></i> Export
                                </button>
                                <button class="btn btn-sm btn-ghost-danger" onclick="clearHits()">
                                    <i class="ti ti-trash"></i> Clear All
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filter & Group Controls -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Filter by Portal</label>
                                <select class="form-select" id="portalFilter" onchange="applyFilters()">
                                    <option value="">All Portals</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Min. Channels</label>
                                <input type="number" class="form-control" id="minChannelsFilter" 
                                       value="0" min="0" onchange="applyFilters()">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">DE Only</label>
                                <select class="form-select" id="deFilter" onchange="applyFilters()">
                                    <option value="">All</option>
                                    <option value="true">ðŸ‡©ðŸ‡ª Only</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Group By</label>
                                <select class="form-select" id="groupBy" onchange="applyFilters()">
                                    <option value="">No Grouping</option>
                                    <option value="portal">By Portal</option>
                                    <option value="de">By DE Status</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Stats Summary -->
                        <div class="row mb-3" id="hitsSummary" style="display: none;">
                            <div class="col-md-3">
                                <div class="card card-sm">
                                    <div class="card-body">
                                        <div class="text-muted">Total Hits</div>
                                        <div class="h3 mb-0" id="totalHits">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-sm">
                                    <div class="card-body">
                                        <div class="text-muted">Unique Portals</div>
                                        <div class="h3 mb-0" id="uniquePortals">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-sm">
                                    <div class="card-body">
                                        <div class="text-muted">DE Hits</div>
                                        <div class="h3 mb-0" id="deHits">0</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-sm">
                                    <div class="card-body">
                                        <div class="text-muted">Avg. Channels</div>
                                        <div class="h3 mb-0" id="avgChannels">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table" id="hitsTable">
                                <thead>
                                    <tr>
                                        <th>Portal</th>
                                        <th>Type</th>
                                        <th>MAC</th>
                                        <th>Expiry</th>
                                        <th>Channels</th>
                                        <th>DE</th>
                                        <th>Found At</th>
                                        <th>Quality</th>
                                        <th class="w-1">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="hitsTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center text-muted py-4">
                                            <i class="ti ti-database-off" style="font-size: 3rem; opacity: 0.3;"></i>
                                            <p class="mt-2">No hits found yet</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
            </div>
            <!-- END FOUND MACS TAB -->
            
        </div>
        <!-- END TAB CONTENT -->
        
    </div>
</div>

<script>
// Auto-refresh every 5 seconds
let refreshInterval = setInterval(refreshStatus, 5000);

// Global hits data
let allHitsData = [];

// Initial load
refreshStatus();
loadSettings();
loadProxies();
loadProxySources();

// Show/hide MAC list based on mode
document.getElementById('scanMode').addEventListener('change', (e) => {
    const macListRow = document.getElementById('macListRow');
    const macFileRow = document.getElementById('macFileRow');
    const xscanRangeRow = document.getElementById('xscanRangeRow');
    const mode = e.target.value;
    
    const isListMode = mode === 'list';
    const isXscanMode = mode === 'xscan';
    
    macListRow.style.display = isListMode ? 'block' : 'none';
    macFileRow.style.display = isListMode ? 'block' : 'none';
    xscanRangeRow.style.display = isXscanMode ? 'block' : 'none';
});

// Handle MAC file upload
document.getElementById('macFileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const text = await file.text();
    document.getElementById('macList').value = text;
});

// Start scan
document.getElementById('scannerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const portalUrl = document.getElementById('portalUrl').value;
    const mode = document.getElementById('scanMode').value;
    const speed = parseInt(document.getElementById('scanSpeed').value);
    const timeout = parseInt(document.getElementById('scanTimeout').value);
    const macPrefix = document.getElementById('macPrefix').value;
    const macList = document.getElementById('macList').value;
    const proxies = document.getElementById('proxies').value;
    
    // Xscan mode parameters
    const macRangeStart = document.getElementById('macRangeStart').value;
    const macRangeEnd = document.getElementById('macRangeEnd').value;
    
    const payload = {
        portal_url: portalUrl,
        mode: mode,
        speed: speed,
        timeout: timeout,
        mac_prefix: macPrefix,
        mac_list: macList,
        proxies: proxies
    };
    
    // Add xscan parameters if in xscan mode
    if (mode === 'xscan') {
        payload.mac_range_start = macRangeStart;
        payload.mac_range_end = macRangeEnd;
    }
    
    const resp = await fetch('/scanner-new/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });
    
    const result = await resp.json();
    if (result.success) {
        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible';
        alert.innerHTML = `
            <div class="d-flex">
                <div><i class="ti ti-check alert-icon"></i></div>
                <div>
                    <h4 class="alert-title">Scan started!</h4>
                    <div class="text-secondary">Attack ID: ${result.attack_id}</div>
                </div>
            </div>
            <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
        `;
        document.querySelector('.page-body .container-xl').insertBefore(alert, document.querySelector('.page-body .container-xl').firstChild);
        
        // Refresh status immediately
        refreshStatus();
        
        // Clear form
        document.getElementById('scannerForm').reset();
    } else {
        alert('Error: ' + result.error);
    }
});

// Format ETA seconds to human readable
function formatETA(seconds) {
    if (!seconds || seconds <= 0) return 'âˆž';
    if (seconds < 60) return `${seconds}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${seconds % 60}s`;
    const hours = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    return `${hours}h ${mins}m`;
}

// Refresh active scans
async function refreshStatus() {
    const resp = await fetch('/scanner-new/attacks');
    const data = await resp.json();
    
    const container = document.getElementById('activeScans');
    
    if (!data.attacks || data.attacks.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center py-4">
                <i class="ti ti-radar" style="font-size: 3rem; opacity: 0.3;"></i>
                <p class="mt-2">No active scans</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    for (const attack of data.attacks) {
        const progress = attack.tested > 0 ? 
            Math.round((attack.hits / attack.tested) * 100) : 0;
        
        const statusBadge = attack.paused ? 
            '<span class="badge bg-warning">Paused</span>' : 
            '<span class="badge bg-success">Running</span>';
        
        html += `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h4 class="mb-1">${attack.portal_url}</h4>
                            <div class="text-muted">
                                <span class="badge bg-blue-lt me-1">${attack.mode}</span>
                                ${statusBadge}
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="btn-list">
                                <button class="btn btn-sm btn-ghost-warning" onclick="pauseAttack('${attack.id}')">
                                    <i class="ti ti-player-pause"></i>
                                </button>
                                <button class="btn btn-sm btn-ghost-danger" onclick="stopAttack('${attack.id}')">
                                    <i class="ti ti-player-stop"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-3">
                            <div class="text-muted">Tested</div>
                            <div class="h3 mb-0">${attack.tested}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted">Hits</div>
                            <div class="h3 mb-0 text-success">${attack.hits}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted">Errors</div>
                            <div class="h3 mb-0 text-danger">${attack.errors}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted">Elapsed</div>
                            <div class="h3 mb-0">${attack.elapsed}s</div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-3">
                            <div class="text-muted">CPM</div>
                            <div class="h4 mb-0 text-info">${attack.cpm || 0}</div>
                            <small class="text-muted">checks/min</small>
                        </div>
                        <div class="col-3">
                            <div class="text-muted">Hit Rate</div>
                            <div class="h4 mb-0 text-success">${attack.hit_rate || 0}%</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted">ETA</div>
                            <div class="h4 mb-0">${formatETA(attack.eta_seconds || 0)}</div>
                        </div>
                        <div class="col-3">
                            <div class="text-muted">Avg Quality</div>
                            <div class="h4 mb-0 text-warning">${attack.avg_quality || 0}</div>
                            <small class="text-muted">/100</small>
                        </div>
                    </div>
                    ${attack.mode === 'list' ? `
                    <div class="mt-2">
                        <div class="text-muted">Progress: ${attack.mac_list_index} / ${attack.mac_list_total}</div>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${(attack.mac_list_index / attack.mac_list_total * 100)}%"></div>
                        </div>
                    </div>
                    ` : ''}
                    <div class="mt-2">
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: ${progress}%">
                                ${progress}% hit rate
                            </div>
                        </div>
                    </div>
                    ${attack.current_mac ? `
                    <div class="mt-2 text-muted small">
                        Current: ${attack.current_mac} ${attack.current_proxy ? '(' + attack.current_proxy + ')' : ''}
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
    
    // Collect all hits from all attacks
    refreshHits();
}

// Refresh found MACs
async function refreshHits() {
    // Get all found MACs from database (no filters - we filter client-side)
    const resp = await fetch('/scanner/found-macs');
    const allHits = await resp.json();
    
    // Also get hits from active attacks (in-memory, not yet saved to DB)
    const attacksResp = await fetch('/scanner-new/attacks');
    const attacksData = await attacksResp.json();
    
    // Collect hits from active attacks
    let activeHits = [];
    if (attacksData.attacks) {
        for (const attack of attacksData.attacks) {
            if (attack.found_macs) {
                activeHits = activeHits.concat(attack.found_macs);
            }
        }
    }
    
    // Merge: persistent (DB) + active (in-memory)
    // Remove duplicates by MAC+Portal (DB hits take precedence)
    const hitMap = new Map();
    
    // Add DB hits first
    for (const hit of allHits) {
        const key = `${hit.mac}|${hit.portal}`;
        hitMap.set(key, hit);
    }
    
    // Add active hits (only if not already in DB)
    for (const hit of activeHits) {
        const key = `${hit.mac}|${hit.portal}`;
        if (!hitMap.has(key)) {
            hitMap.set(key, hit);
        }
    }
    
    allHitsData = Array.from(hitMap.values());
    
    // Update portal filter dropdown
    updatePortalFilter();
    
    // Apply filters and display
    applyFilters();
}

// Update portal filter dropdown
function updatePortalFilter() {
    const portalFilter = document.getElementById('portalFilter');
    const uniquePortals = [...new Set(allHitsData.map(h => h.portal))];
    
    // Keep current selection
    const currentValue = portalFilter.value;
    
    // Rebuild options
    portalFilter.innerHTML = '<option value="">All Portals</option>';
    for (const portal of uniquePortals.sort()) {
        const option = document.createElement('option');
        option.value = portal;
        option.textContent = portal;
        portalFilter.appendChild(option);
    }
    
    // Restore selection
    portalFilter.value = currentValue;
}

// Apply filters and grouping
function applyFilters() {
    const portalFilter = document.getElementById('portalFilter').value;
    const minChannels = parseInt(document.getElementById('minChannelsFilter').value) || 0;
    const deFilter = document.getElementById('deFilter').value;
    const groupBy = document.getElementById('groupBy').value;
    
    // Filter hits
    let filteredHits = allHitsData.filter(hit => {
        if (portalFilter && hit.portal !== portalFilter) return false;
        if (hit.channels < minChannels) return false;
        if (deFilter === 'true' && !hit.has_de) return false;
        return true;
    });
    
    // Update stats
    updateStats(filteredHits);
    
    // Display hits
    if (groupBy === 'portal') {
        displayGroupedByPortal(filteredHits);
    } else if (groupBy === 'de') {
        displayGroupedByDE(filteredHits);
    } else {
        displayHits(filteredHits);
    }
}

// Update statistics
function updateStats(hits) {
    const summary = document.getElementById('hitsSummary');
    
    if (hits.length === 0) {
        summary.style.display = 'none';
        return;
    }
    
    summary.style.display = 'flex';
    
    const uniquePortals = new Set(hits.map(h => h.portal)).size;
    const deHits = hits.filter(h => h.has_de).length;
    const avgChannels = Math.round(hits.reduce((sum, h) => sum + h.channels, 0) / hits.length);
    
    document.getElementById('totalHits').textContent = hits.length;
    document.getElementById('uniquePortals').textContent = uniquePortals;
    document.getElementById('deHits').textContent = deHits;
    document.getElementById('avgChannels').textContent = avgChannels;
}

// Display hits (no grouping)
function displayHits(hits) {
    const tbody = document.getElementById('hitsTableBody');
    
    if (!hits || hits.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted py-4">
                    <i class="ti ti-database-off" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-2">No hits found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    // Sort by found_at descending (newest first)
    hits.sort((a, b) => new Date(b.found_at) - new Date(a.found_at));
    
    let html = '';
    for (const hit of hits) {
        html += renderHitRow(hit);
    }
    
    tbody.innerHTML = html;
}

// Display hits grouped by portal
function displayGroupedByPortal(hits) {
    const tbody = document.getElementById('hitsTableBody');
    
    if (!hits || hits.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted py-4">
                    <i class="ti ti-database-off" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-2">No hits found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    // Group by portal
    const grouped = {};
    for (const hit of hits) {
        if (!grouped[hit.portal]) {
            grouped[hit.portal] = [];
        }
        grouped[hit.portal].push(hit);
    }
    
    let html = '';
    for (const [portal, portalHits] of Object.entries(grouped).sort()) {
        // Group header
        html += `
            <tr class="table-active">
                <td colspan="9">
                    <strong>${portal}</strong>
                    <span class="badge bg-blue-lt ms-2">${portalHits.length} hits</span>
                </td>
            </tr>
        `;
        
        // Sort hits by found_at
        portalHits.sort((a, b) => new Date(b.found_at) - new Date(a.found_at));
        
        // Hits
        for (const hit of portalHits) {
            html += renderHitRow(hit);
        }
    }
    
    tbody.innerHTML = html;
}

// Display hits grouped by DE status
function displayGroupedByDE(hits) {
    const tbody = document.getElementById('hitsTableBody');
    
    if (!hits || hits.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted py-4">
                    <i class="ti ti-database-off" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-2">No hits found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    // Group by DE status
    const deHits = hits.filter(h => h.has_de);
    const nonDeHits = hits.filter(h => !h.has_de);
    
    let html = '';
    
    // DE Hits
    if (deHits.length > 0) {
        html += `
            <tr class="table-active">
                <td colspan="9">
                    <strong>ðŸ‡©ðŸ‡ª German Channels</strong>
                    <span class="badge bg-blue-lt ms-2">${deHits.length} hits</span>
                </td>
            </tr>
        `;
        
        deHits.sort((a, b) => new Date(b.found_at) - new Date(a.found_at));
        for (const hit of deHits) {
            html += renderHitRow(hit);
        }
    }
    
    // Non-DE Hits
    if (nonDeHits.length > 0) {
        html += `
            <tr class="table-active">
                <td colspan="9">
                    <strong>Other Channels</strong>
                    <span class="badge bg-blue-lt ms-2">${nonDeHits.length} hits</span>
                </td>
            </tr>
        `;
        
        nonDeHits.sort((a, b) => new Date(b.found_at) - new Date(a.found_at));
        for (const hit of nonDeHits) {
            html += renderHitRow(hit);
        }
    }
    
    tbody.innerHTML = html;
}

// Render single hit row
function renderHitRow(hit) {
    const deIcon = hit.has_de ? 'ðŸ‡©ðŸ‡ª' : '';
    const foundAt = new Date(hit.found_at).toLocaleString();
    const portalType = hit.portal_type || 'unknown';
    const portalTypeIcon = portalType.startsWith('stalker') ? 'ðŸ“¡' : 'â“';
    const qualityScore = hit.quality_score || 0;
    
    // Quality score color
    let qualityColor = 'secondary';
    if (qualityScore >= 80) qualityColor = 'success';
    else if (qualityScore >= 60) qualityColor = 'info';
    else if (qualityScore >= 40) qualityColor = 'warning';
    else qualityColor = 'danger';
    
    return `
        <tr>
            <td><small class="text-muted">${hit.portal}</small></td>
            <td><span class="badge bg-secondary-lt">${portalTypeIcon} ${portalType}</span></td>
            <td><code>${hit.mac}</code></td>
            <td>${hit.expiry}</td>
            <td><span class="badge bg-blue-lt">${hit.channels}</span></td>
            <td>${deIcon}</td>
            <td><small class="text-muted">${foundAt}</small></td>
            <td>
                <span class="badge bg-${qualityColor}" title="Quality Score">${qualityScore}/100</span>
            </td>
            <td>
                <div class="btn-list">
                    <button class="btn btn-sm btn-success" 
                            onclick='createPortal(${JSON.stringify(hit).replace(/'/g, "&#39;")})'>
                        <i class="ti ti-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-info" 
                            onclick='convertToM3U("${hit.mac}", "${hit.portal}")' 
                            title="Convert to M3U">
                        <i class="ti ti-file-download"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
}

// Pause attack
async function pauseAttack(attackId) {
    const resp = await fetch('/scanner/pause', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({attack_id: attackId})
    });
    
    const result = await resp.json();
    if (result.success) {
        refreshStatus();
    }
}

// Stop attack
async function stopAttack(attackId) {
    if (!confirm('Stop this scan?')) {
        return;
    }
    
    const resp = await fetch('/scanner/stop', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({attack_id: attackId})
    });
    
    const result = await resp.json();
    if (result.success) {
        refreshStatus();
    }
}

// Create portal from hit
async function createPortal(hitData) {
    if (!confirm(`Create portal from MAC ${hitData.mac}?`)) {
        return;
    }
    
    const resp = await fetch('/scanner/create-portal', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({hit_data: hitData})
    });
    
    const result = await resp.json();
    
    if (result.success) {
        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible';
        alert.innerHTML = `
            <div class="d-flex">
                <div><i class="ti ti-check alert-icon"></i></div>
                <div>
                    <h4 class="alert-title">Portal created!</h4>
                    <div class="text-secondary">${result.portal_name}</div>
                </div>
            </div>
            <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
        `;
        document.querySelector('.page-body .container-xl').insertBefore(alert, document.querySelector('.page-body .container-xl').firstChild);
        
        // Redirect to portals page after 2 seconds
        setTimeout(() => {
            window.location.href = '/portals';
        }, 2000);
    } else {
        alert('Error: ' + result.error);
    }
}

// Auto-detect portal endpoint
async function autoDetectPortal() {
    const portalUrlInput = document.getElementById('portalUrl');
    const portalUrl = portalUrlInput.value.trim();
    
    if (!portalUrl) {
        alert('Please enter a portal URL first');
        return;
    }
    
    try {
        const resp = await fetch('/scanner-new/auto-detect-portal', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({portal_url: portalUrl})
        });
        
        const result = await resp.json();
        
        if (result.success) {
            portalUrlInput.value = result.detected_url;
            
            // Show success message with portal info
            const message = `âœ… Portal detected!\n\nURL: ${result.detected_url}\nType: ${result.portal_type}\nVersion: ${result.version}`;
            alert(message);
        } else {
            alert(`âŒ Auto-detection failed: ${result.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Auto-detect error:', error);
        alert(`âŒ Auto-detection failed: ${error.message}`);
    }
}

// Convert MAC to M3U playlist
async function convertToM3U(mac, portal) {
    if (!confirm(`Convert ${mac} to M3U playlist?`)) {
        return;
    }
    
    try {
        const resp = await fetch('/scanner/convert-mac2m3u', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mac: mac, portal_url: portal})
        });
        
        if (resp.ok) {
            const blob = await resp.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${mac.replace(/:/g, '')}.m3u`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible';
            alert.innerHTML = `
                <div class="d-flex">
                    <div><i class="ti ti-check alert-icon"></i></div>
                    <div>
                        <h4 class="alert-title">M3U Downloaded!</h4>
                        <div class="text-secondary">${mac}</div>
                    </div>
                </div>
                <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
            `;
            document.querySelector('.page-body .container-xl').insertBefore(alert, document.querySelector('.page-body .container-xl').firstChild);
        } else {
            const result = await resp.json();
            alert('Error: ' + (result.error || 'Failed to convert'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    clearInterval(refreshInterval);
});

// Export hits
async function exportHits() {
    window.location.href = '/scanner/export-found-macs';
}

// Clear all hits
async function clearHits() {
    if (!confirm('Clear all found MACs? This cannot be undone!')) {
        return;
    }
    
    const resp = await fetch('/scanner/found-macs', {
        method: 'DELETE'
    });
    
    const result = await resp.json();
    if (result.success) {
        alert('All found MACs cleared!');
        refreshHits();
    } else {
        alert('Error clearing MACs');
    }
}

// Portal Crawler - Find new portals from urlscan.io
async function crawlPortals() {
    if (!confirm('Search for new portals on urlscan.io? This may take a few seconds.')) {
        return;
    }
    
    try {
        const resp = await fetch('/scanner-new/crawl-portals', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await resp.json();
        
        if (result.success && result.portals && result.portals.length > 0) {
            // Show portals in a modal or alert
            let portalList = result.portals.slice(0, 10).join('\n');
            if (result.portals.length > 10) {
                portalList += `\n... and ${result.portals.length - 10} more`;
            }
            alert(`Found ${result.count} portals:\n\n${portalList}\n\nCopy these portals to scan them!`);
        } else {
            alert('No new portals found. Try again later.');
        }
    } catch (error) {
        console.error('Portal crawl error:', error);
        alert('Error crawling portals: ' + error.message);
    }
}

// Export All MACs to M3U
async function exportAllToM3U() {
    // Get current filters
    const portalFilter = document.getElementById('portalFilter').value;
    const minChannels = parseInt(document.getElementById('minChannelsFilter').value) || 0;
    const deOnly = document.getElementById('deFilter').value === 'true';
    
    // Confirm export
    const filterDesc = [];
    if (portalFilter) filterDesc.push(`Portal: ${portalFilter}`);
    if (minChannels > 0) filterDesc.push(`Min ${minChannels} channels`);
    if (deOnly) filterDesc.push('DE only');
    
    const filterText = filterDesc.length > 0 ? `\nFilters: ${filterDesc.join(', ')}` : '';
    
    if (!confirm(`Export all found MACs as single M3U playlist?${filterText}\n\nThis may take 1-2 minutes for many MACs.`)) {
        return;
    }
    
    try {
        // Show loading indicator
        const originalText = event.target.innerHTML;
        event.target.innerHTML = '<i class="ti ti-loader ti-spin"></i> Exporting...';
        event.target.disabled = true;
        
        const resp = await fetch('/scanner-new/export-all-m3u', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                portal: portalFilter || null,
                min_channels: minChannels,
                de_only: deOnly,
                max_macs: 50  // Limit to 50 MACs to avoid timeout
            })
        });
        
        if (resp.ok) {
            // Download the M3U file
            const blob = await resp.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scanner_all_macs_${Date.now()}.m3u`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('M3U export complete!');
        } else {
            const error = await resp.json();
            alert('Export failed: ' + (error.error || 'Unknown error'));
        }
        
        // Restore button
        event.target.innerHTML = originalText;
        event.target.disabled = false;
        
    } catch (error) {
        console.error('M3U export error:', error);
        alert('Error exporting M3U: ' + error.message);
        
        // Restore button
        event.target.innerHTML = originalText;
        event.target.disabled = false;
    }
}

// ============== SETTINGS FUNCTIONS ==============

async function loadSettings() {
    try {
        const resp = await fetch('/scanner/settings');
        const settings = await resp.json();
        
        document.getElementById('settingSpeed').value = settings.speed || 100;
        document.getElementById('settingTimeout').value = settings.timeout || 10;
        document.getElementById('settingMacPrefix').value = settings.mac_prefix || '00:1A:79:';
        document.getElementById('settingMinChannels').value = settings.min_channels_for_valid_hit || 1;
        document.getElementById('settingMaxProxyErrors').value = settings.max_proxy_errors || 10;
        document.getElementById('settingProxyRotation').value = settings.proxy_rotation_percentage || 80;
        document.getElementById('settingRequestDelay').value = settings.request_delay || 0;
        document.getElementById('settingForceProxyRotation').value = settings.force_proxy_rotation_every || 0;
        document.getElementById('settingUserAgentRotation').checked = settings.user_agent_rotation || false;
        document.getElementById('settingUseProxies').checked = settings.use_proxies || false;
        document.getElementById('settingAutoSave').checked = settings.auto_save !== false;
        document.getElementById('settingRequireChannels').checked = settings.require_channels_for_valid_hit !== false;
        document.getElementById('settingUnlimitedRetries').checked = settings.unlimited_mac_retries !== false;
        document.getElementById('settingMaxProxyAttempts').value = settings.max_proxy_attempts_per_mac || 20;
        document.getElementById('settingCompatibleMode').checked = settings.macattack_compatible_mode || false;
        
        // Advanced settings
        document.getElementById('settingCloudflareBypass').checked = settings.cloudflare_bypass !== false;
        document.getElementById('settingRandomXForwardedFor').checked = settings.random_x_forwarded_for !== false;
        document.getElementById('settingDeduplicateMACs').checked = settings.deduplicate_mac_lists !== false;
        document.getElementById('settingGenerateNeighborMACs').checked = settings.generate_neighbor_macs || false;
        document.getElementById('settingNeighborRange').value = settings.neighbor_mac_range || 5;
        
        // Show/hide neighbor range row
        document.getElementById('neighborRangeRow').style.display = 
            settings.generate_neighbor_macs ? 'block' : 'none';
    } catch (e) {
        console.error('Error loading settings:', e);
    }
}

// Toggle neighbor range row
document.getElementById('settingGenerateNeighborMACs').addEventListener('change', (e) => {
    document.getElementById('neighborRangeRow').style.display = e.target.checked ? 'block' : 'none';
});

async function saveSettings() {
    const settings = {
        speed: parseInt(document.getElementById('settingSpeed').value),
        timeout: parseInt(document.getElementById('settingTimeout').value),
        mac_prefix: document.getElementById('settingMacPrefix').value,
        min_channels_for_valid_hit: parseInt(document.getElementById('settingMinChannels').value),
        max_proxy_errors: parseInt(document.getElementById('settingMaxProxyErrors').value),
        proxy_rotation_percentage: parseInt(document.getElementById('settingProxyRotation').value),
        request_delay: parseFloat(document.getElementById('settingRequestDelay').value),
        force_proxy_rotation_every: parseInt(document.getElementById('settingForceProxyRotation').value),
        user_agent_rotation: document.getElementById('settingUserAgentRotation').checked,
        use_proxies: document.getElementById('settingUseProxies').checked,
        auto_save: document.getElementById('settingAutoSave').checked,
        require_channels_for_valid_hit: document.getElementById('settingRequireChannels').checked,
        unlimited_mac_retries: document.getElementById('settingUnlimitedRetries').checked,
        max_proxy_attempts_per_mac: parseInt(document.getElementById('settingMaxProxyAttempts').value),
        macattack_compatible_mode: document.getElementById('settingCompatibleMode').checked,
        // Advanced Settings
        cloudflare_bypass: document.getElementById('settingCloudflareBypass').checked,
        random_x_forwarded_for: document.getElementById('settingRandomXForwardedFor').checked,
        deduplicate_mac_lists: document.getElementById('settingDeduplicateMACs').checked,
        generate_neighbor_macs: document.getElementById('settingGenerateNeighborMACs').checked,
        neighbor_mac_range: parseInt(document.getElementById('settingNeighborRange').value)
    };
    
    try {
        const resp = await fetch('/scanner/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(settings)
        });
        
        const result = await resp.json();
        if (result.success) {
            alert('Settings saved successfully!');
        } else {
            alert('Error saving settings');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// ============== PRESET FUNCTIONS ==============

function applyMaxAccuracy() {
    document.getElementById('settingSpeed').value = 75;
    document.getElementById('settingTimeout').value = 15;
    document.getElementById('settingMaxProxyErrors').value = 10;
    document.getElementById('settingProxyRotation').value = 70;
    document.getElementById('settingUnlimitedRetries').checked = true;
    alert('âœ… Max Accuracy settings applied! Click "Save Settings" to save.');
}

function applyBalanced() {
    document.getElementById('settingSpeed').value = 150;
    document.getElementById('settingTimeout').value = 12;
    document.getElementById('settingMaxProxyErrors').value = 6;
    document.getElementById('settingProxyRotation').value = 50;
    document.getElementById('settingUnlimitedRetries').checked = false;
    alert('âš–ï¸ Balanced settings applied! Click "Save Settings" to save.');
}

function applyFastScan() {
    document.getElementById('settingSpeed').value = 350;
    document.getElementById('settingTimeout').value = 8;
    document.getElementById('settingMaxProxyErrors').value = 4;
    document.getElementById('settingProxyRotation').value = 30;
    document.getElementById('settingUnlimitedRetries').checked = false;
    alert('ðŸš€ Fast Scan settings applied! Click "Save Settings" to save.');
}

function applyStealth() {
    document.getElementById('settingSpeed').value = 25;
    document.getElementById('settingTimeout').value = 12;
    document.getElementById('settingRequestDelay').value = 1.5;
    document.getElementById('settingForceProxyRotation').value = 5;
    document.getElementById('settingUserAgentRotation').checked = true;
    document.getElementById('settingMaxProxyErrors').value = 8;
    document.getElementById('settingProxyRotation').value = 60;
    alert('ðŸ¥· Stealth Mode settings applied! Click "Save Settings" to save.');
}

function applyNoProxy() {
    document.getElementById('settingSpeed').value = 35;
    document.getElementById('settingTimeout').value = 20;
    document.getElementById('settingUseProxies').checked = false;
    alert('ðŸ”— No Proxy settings applied! Click "Save Settings" to save.');
}

// ============== PROXY FUNCTIONS ==============

async function loadProxies() {
    try {
        const resp = await fetch('/scanner/proxies');
        const data = await resp.json();
        
        if (data.proxies && data.proxies.length > 0) {
            document.getElementById('proxyList').value = data.proxies.join('\n');
            document.getElementById('proxyCount').textContent = data.proxies.length;
        } else {
            document.getElementById('proxyList').value = '';
            document.getElementById('proxyCount').textContent = '0';
        }
    } catch (e) {
        console.error('Error loading proxies:', e);
    }
}

async function saveProxies() {
    const proxies = document.getElementById('proxyList').value;
    
    try {
        const resp = await fetch('/scanner/proxies', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({proxies: proxies})
        });
        
        const result = await resp.json();
        if (result.success) {
            document.getElementById('proxyCount').textContent = result.count || 0;
            alert('Proxies saved successfully!');
        } else {
            alert('Error saving proxies');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function loadProxySources() {
    try {
        const resp = await fetch('/scanner/proxy-sources');
        const data = await resp.json();
        
        if (data.sources && data.sources.length > 0) {
            document.getElementById('proxySources').value = data.sources.join('\n');
        }
    } catch (e) {
        console.error('Error loading proxy sources:', e);
    }
}

async function saveProxySources() {
    const sources = document.getElementById('proxySources').value;
    
    try {
        const resp = await fetch('/scanner/proxy-sources', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({sources: sources})
        });
        
        const result = await resp.json();
        if (result.success) {
            alert('Proxy sources saved successfully!');
        } else {
            alert('Error saving proxy sources');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function fetchProxies() {
    try {
        const resp = await fetch('/scanner/proxies/fetch', {method: 'POST'});
        const result = await resp.json();
        
        if (result.success) {
            alert('Fetching proxies... Check proxy log for progress.');
            startProxyPolling();
        } else {
            alert('Error fetching proxies');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function testProxies() {
    try {
        const resp = await fetch('/scanner/proxies/test', {method: 'POST'});
        const result = await resp.json();
        
        if (result.success) {
            alert('Testing proxies... Check proxy log for progress.');
            startProxyPolling();
        } else {
            alert('Error testing proxies');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function testAutodetect() {
    try {
        const resp = await fetch('/scanner/proxies/test-autodetect', {method: 'POST'});
        const result = await resp.json();
        
        if (result.success) {
            alert('Testing and auto-detecting proxy types... Check proxy log for progress.');
            startProxyPolling();
        } else {
            alert('Error testing proxies');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function removeFailedProxies() {
    if (!confirm('Remove all failed proxies?')) {
        return;
    }
    
    try {
        const resp = await fetch('/scanner/proxies/remove-failed', {method: 'POST'});
        const result = await resp.json();
        
        if (result.success) {
            alert(`Removed ${result.removed} failed proxies. ${result.remaining} remaining.`);
            loadProxies();
        } else {
            alert('No failed proxies to remove');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function resetProxyErrors() {
    try {
        const resp = await fetch('/scanner/proxies/reset-errors', {method: 'POST'});
        const result = await resp.json();
        
        if (result.success) {
            alert('Proxy errors reset successfully!');
        } else {
            alert('Error resetting proxy errors');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

let proxyPollingInterval = null;

function startProxyPolling() {
    if (proxyPollingInterval) clearInterval(proxyPollingInterval);
    proxyPollingInterval = setInterval(updateProxyStatus, 1000);
}

async function updateProxyStatus() {
    try {
        const resp = await fetch('/scanner/proxies/status');
        const data = await resp.json();
        
        const logBox = document.getElementById('proxyLog');
        if (data.logs && data.logs.length > 0) {
            logBox.innerHTML = data.logs.map(l => 
                `<div style="color: ${l.level === 'error' ? '#ff6b6b' : l.level === 'success' ? '#51cf66' : '#adb5bd'}">
                    [${l.time}] ${l.message}
                </div>`
            ).join('');
            logBox.scrollTop = logBox.scrollHeight;
        }
        
        if (data.proxies && data.proxies.length > 0) {
            document.getElementById('proxyList').value = data.proxies.join('\n');
            document.getElementById('proxyCount').textContent = data.proxies.length;
        }
        
        if (!data.fetching && !data.testing) {
            clearInterval(proxyPollingInterval);
            proxyPollingInterval = null;
        }
    } catch (e) {
        console.error('Error updating proxy status:', e);
    }
}

</script>

{% endblock %}
