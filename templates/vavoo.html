{% extends "base.html" %}

{% block title %}Vavoo IPTV Proxy - MacReplayXC{% endblock %}

{% block head %}
<style>
    .vavoo-container {
        position: fixed;
        top: 60px; /* Height of navbar */
        left: 0;
        right: 0;
        bottom: 0;
        padding: 0;
        margin: 0;
        overflow: hidden;
    }

    .vavoo-iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
    }

    .vavoo-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 1;
    }

    .vavoo-error {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        max-width: 600px;
        padding: 20px;
    }

    /* Hide page wrapper padding for fullscreen iframe */
    .page-wrapper {
        padding: 0 !important;
    }

    .page-wrapper > .container-xl {
        max-width: 100% !important;
        padding: 0 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="vavoo-container">
    <div class="vavoo-loading" id="vavooLoading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading Vavoo IPTV Proxy...</p>
    </div>

    <div class="vavoo-error" id="vavooError" style="display: none;">
        <div class="alert alert-danger">
            <h4 class="alert-title">
                <i class="ti ti-alert-triangle"></i>
                Vavoo Service Not Available
            </h4>
            <div class="text-muted">
                <p>The Vavoo IPTV Proxy service is not running or not accessible.</p>
                <p><strong>Please ensure:</strong></p>
                <ul class="text-start">
                    <li>Vavoo container is running: <code>docker ps | grep Vavoo</code></li>
                    <li>Port 4323 is accessible</li>
                    <li>Both containers are in the same network</li>
                </ul>
                <p class="mb-0">
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="ti ti-refresh"></i>
                        Retry
                    </button>
                </p>
            </div>
        </div>
    </div>

    <iframe 
        id="vavooFrame" 
        class="vavoo-iframe" 
        src="http://localhost:4323/"
        style="display: none;"
        title="Vavoo IPTV Proxy"
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-downloads"
    ></iframe>
</div>

<script>
    const iframe = document.getElementById('vavooFrame');
    const loading = document.getElementById('vavooLoading');
    const error = document.getElementById('vavooError');
    let loadTimeout;

    // Show error after 10 seconds if not loaded
    loadTimeout = setTimeout(() => {
        loading.style.display = 'none';
        error.style.display = 'block';
    }, 10000);

    iframe.addEventListener('load', () => {
        clearTimeout(loadTimeout);
        loading.style.display = 'none';
        iframe.style.display = 'block';
    });

    iframe.addEventListener('error', () => {
        clearTimeout(loadTimeout);
        loading.style.display = 'none';
        error.style.display = 'block';
    });

    // Fallback: Try to detect if iframe loaded successfully
    setTimeout(() => {
        try {
            // If iframe is still hidden after 5 seconds, something went wrong
            if (iframe.style.display === 'none' && loading.style.display !== 'none') {
                loading.style.display = 'none';
                error.style.display = 'block';
            }
        } catch (e) {
            // Cross-origin error is expected, ignore
        }
    }, 5000);
</script>
{% endblock %}

{% block scripts %}
<script>
    // Prevent navigation away from Vavoo page when clicking links in iframe
    // This is handled by the iframe itself
</script>
{% endblock %}
